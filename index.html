<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Shooting Game</title>
<style>
  body {
    margin: 0;
    background: #001a33;
    overflow: hidden;
  }
  canvas {
    display: block;
    margin: auto;
    background: #003366;
  }
  #ui {
    position: fixed;
    top: 10px;
    left: 10px;
    color: white;
  }
</style>
</head>
<body>

<div id="ui"></div>
<canvas id="game" width="480" height="640"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const ui = document.getElementById("ui");

const ENEMY_SPEED = 2;

/* ===== Áä∂ÊÖã ===== */
let gameOver = false;
let score = 0;
let kills = 0;
let bossPhase = 0;
let bgY = 0;

/* ===== Ëá™Ê©ü ===== */
const player = {
  x: 240,
  y: 520,
  life: 5,
  maxLife: 5,
  weapon: 1,
  invincible: 0,
  shooting: false
};

/* ===== ÈÖçÂàó ===== */
let bullets = [];
let enemies = [];
let enemyBullets = [];
let items = [];
let boss = null;

/* ===== Êìç‰Ωú ===== */
canvas.addEventListener("mousemove", e => {
  const r = canvas.getBoundingClientRect();
  player.x = e.clientX - r.left;
  player.y = e.clientY - r.top;
});
canvas.addEventListener("mousedown", () => player.shooting = true);
canvas.addEventListener("mouseup", () => player.shooting = false);

document.addEventListener("keydown", e => {
  if (e.key === "r" && gameOver) location.reload();
});

/* ===== Âºæ ===== */
let shotCooldown = 0;
function shoot() {
  if (shotCooldown > 0) return;
  shotCooldown = 10;

  if (player.weapon === 1) {
    bullets.push({x: player.x, y: player.y, vy: -8});
  } else {
    bullets.push({x: player.x - 8, y: player.y, vy: -8});
    bullets.push({x: player.x + 8, y: player.y, vy: -8});
  }
}

/* ===== Êïµ ===== */
function spawnEnemy() {
  if (boss) return;
  enemies.push({
    x: Math.random() * 420 + 30,
    y: -40,
    shootTimer: 60
  });
}

/* ===== „Éú„Çπ ===== */
function spawnBoss() {
  boss = {
    x: 240,
    y: 120,
    maxHp: 50 + bossPhase * 20,
    hp: 50 + bossPhase * 20,
    timer: 0
  };
}

/* ===== Êõ¥Êñ∞ ===== */
function update() {
  if (gameOver) return;

  bgY = (bgY + 1) % canvas.height;

  if (player.shooting) shoot();
  if (shotCooldown > 0) shotCooldown--;
  if (player.invincible > 0) player.invincible--;

  /* Ëá™Ê©üÂºæ */
  bullets.forEach(b => b.y += b.vy);
  bullets = bullets.filter(b => b.y > -20);

  /* Êïµ */
  enemies.forEach(e => {
    e.y += ENEMY_SPEED;
    e.shootTimer--;
    if (e.shootTimer <= 0) {
      enemyBullets.push({x: e.x, y: e.y, vy: 4});
      e.shootTimer = 90;
    }
  });
  enemies = enemies.filter(e => e.y < 700);

  /* ÊïµÂºæ */
  enemyBullets.forEach(b => b.y += b.vy);
  enemyBullets = enemyBullets.filter(b => b.y < 700);

  /* „Éú„Çπ */
  if (boss) {
    boss.timer++;
    if (boss.timer % 30 === 0) {
      [-40, 0, 40].forEach(dx => {
        enemyBullets.push({x: boss.x + dx, y: boss.y, vy: 4});
      });
    }
  }

  /* ÂΩì„Åü„ÇäÂà§ÂÆöÔºàÂºæ‚ÜíÊïµÔºâ */
  bullets.forEach(b => {
    enemies.forEach(e => {
      if (hit(b, e)) {
        e.y = 999;
        b.y = -999;
        score += 100;
        kills++;

        // ‚òÖ „Ç¢„Ç§„ÉÜ„É†„Éâ„É≠„ÉÉ„Éó
        if (Math.random() < 0.3) {
          const type = Math.random() < 0.5 ? "heal" : "weapon";
          items.push({x: e.x, y: e.y, type});
        }
      }
    });

    if (boss && hit(b, boss)) {
      boss.hp--;
      b.y = -999;
      if (boss.hp <= 0) {
        boss = null;
        bossPhase++;
        kills = 0;
      }
    }
  });

  /* ÊïµÂºæ‚ÜíËá™Ê©ü */
  enemyBullets.forEach(b => {
    if (player.invincible === 0 && hit(b, player)) {
      player.life--;
      player.weapon = Math.max(1, player.weapon - 1);
      player.invincible = 60;
      b.y = 999;
      if (player.life <= 0) gameOver = true;
    }
  });

  /* „Ç¢„Ç§„ÉÜ„É† */
  items.forEach(i => {
    i.y += 2;
    if (hit(i, player)) {
      if (i.type === "heal") {
        player.life = Math.min(player.maxLife, player.life + 1);
      }
      if (i.type === "weapon") {
        player.weapon = Math.min(2, player.weapon + 1);
      }
      i.y = 999;
    }
  });
  items = items.filter(i => i.y < 700);

  if (kills >= 20 && !boss) spawnBoss();
  if (Math.random() < 0.02) spawnEnemy();
}

/* ===== ÊèèÁîª ===== */
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.fillStyle = "#004488";
  ctx.fillRect(0, bgY, canvas.width, canvas.height);
  ctx.fillRect(0, bgY - canvas.height, canvas.width, canvas.height);

  /* ‚úàÔ∏è Ëá™Ê©ü */
  ctx.save();
  ctx.translate(player.x, player.y);
  ctx.fillStyle = player.invincible ? "rgba(255,255,255,0.5)" : "#00ffcc";
  ctx.beginPath();
  ctx.moveTo(0, -20);
  ctx.lineTo(12, 20);
  ctx.lineTo(0, 10);
  ctx.lineTo(-12, 20);
  ctx.closePath();
  ctx.fill();
  ctx.fillRect(-20, 5, 40, 4);
  ctx.restore();

  /* Ëá™Ê©üÂºæ */
  ctx.fillStyle = "#ffff00";
  bullets.forEach(b => ctx.fillRect(b.x - 2, b.y - 6, 4, 12));

  /* üö¢ Êïµ */
  enemies.forEach(e => {
    ctx.fillStyle = "#777";
    ctx.fillRect(e.x - 20, e.y - 10, 40, 20);
    ctx.fillStyle = "#444";
    ctx.fillRect(e.x - 6, e.y - 18, 12, 8);
  });

  /* ÊïµÂºæ */
  ctx.fillStyle = "#ffcc00";
  enemyBullets.forEach(b => ctx.fillRect(b.x - 3, b.y - 6, 6, 12));

  /* „Éú„Çπ */
  if (boss) {
    ctx.fillStyle = "#555";
    ctx.fillRect(boss.x - 80, boss.y - 20, 160, 40);
    ctx.fillStyle = "#333";
    ctx.fillRect(boss.x - 20, boss.y - 35, 40, 15);

    // HP„Éê„Éº
    ctx.fillStyle = "#000";
    ctx.fillRect(90, 10, 300, 10);
    ctx.fillStyle = "#ff3333";
    ctx.fillRect(90, 10, 300 * (boss.hp / boss.maxHp), 10);
  }

  /* „Ç¢„Ç§„ÉÜ„É†ÔºàÔºãÔºè‚ÜëÔºâ */
  items.forEach(i => {
    ctx.fillStyle = i.type === "heal" ? "#00ff00" : "#00aaff";
    ctx.fillRect(i.x - 10, i.y - 10, 20, 20);
    ctx.fillStyle = "#000";
    ctx.font = "16px sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(i.type === "heal" ? "Ôºã" : "‚Üë", i.x, i.y);
  });

  ui.innerHTML = `
    SCORE: ${score}<br>
    LIFE: ${player.life}<br>
    WEAPON Lv.${player.weapon}
    ${gameOver ? "<br><b>GAME OVER<br>R„ÅßÂÜç„Çπ„Çø„Éº„Éà</b>" : ""}
  `;
}

/* ===== Âà§ÂÆö ===== */
function hit(a, b) {
  return Math.abs(a.x - b.x) < 20 && Math.abs(a.y - b.y) < 20;
}

/* ===== „É´„Éº„Éó ===== */
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
